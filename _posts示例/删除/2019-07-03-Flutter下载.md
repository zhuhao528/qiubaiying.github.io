---
layout:     post
title:      使用dio下载文件
subtitle:	  Flutter下载问题
date:       2019-06-22
author:     Neil
header-img: img/post-bg-coffee.jpeg
catalog: 	 true
tags:
    - Flutter
---

有一个下载课件的需求，使用到了dio的框架，自测的时候发现模拟器和真机会有所不同，也表现在代码的健壮性上吧～

下面贴一下代码吧

```
preDownLoadPdfsPath(List<Coursewares> coursewares) async {
  coursewares.forEach((courseware) async {
    var name = courseware.url.split("/").last;
    var downloadPath = preDownPath + "/" + "download" + name;
    var realPath = preDownPath + "/" + name;
    print("url");
    print(courseware.url);
    print("downPath");
    print(preDownPath);
    print("name");
    print(name);
    Dio dio = new Dio();
    File filePr = File(downloadPath);
    var isPrExist = await filePr.exists();
    if(isPrExist){
      await filePr.delete(); // 删除之前没有下载完成的文件
    }
    File fileReal = File(realPath);
    var isExist = await fileReal.exists(); //判断之前是否已经下载完成
    print(isExist);
    if (!isExist) {
      // 必须加上 否则download 报 can not open file
      File file = new File(downloadPath);
      file.create(recursive: true);
      dio.download(courseware.url, downloadPath,
          onReceiveProgress: (received, total) {
        if (total != -1) {
          print((received / total * 100).toStringAsFixed(0) + "%");
          if (received == total) {
            File(downloadPath).rename(realPath);
          }
        }
      });
    }
  });
}
```

这个地方值得注意的是下载之前需要判断文件夹是否存在没有的情况下需要

```
File file = new File(downloadPath);
file.create(recursive: true);
```

不然的话真机会报报 can not open file的错误

这里还有一个小心思就是下载之前的文件名称加上download下载完成之后改成原文件名，这样避免文件下载中的使用问题

参考  
[flutterchina/dio](https://github.com/flutterchina/dio/blob/master/README-ZH.md#dio-apis)  



